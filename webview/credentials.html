<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';"
    />
    <title>L1X Credentials</title>
    <style>
      body {
        font-family: var(--vscode-font-family);
        font-size: var(--vscode-font-size);
        color: var(--vscode-foreground);
        background-color: var(--vscode-editor-background);
        margin: 0;
        padding: 20px;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--vscode-panel-border);
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        color: var(--vscode-foreground);
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        border-bottom-color: var(--vscode-focusBorder);
        color: var(--vscode-focusBorder);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .environment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .add-credential-btn {
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border: 1px solid var(--vscode-button-border);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
      }

      .add-credential-btn:hover {
        background-color: var(--vscode-button-hoverBackground);
      }

      .credential-set {
        border: 1px solid var(--vscode-panel-border);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
      }

      .credential-set.testing {
        border-color: #ffa500;
        background-color: rgba(255, 165, 0, 0.1);
      }

      .credential-set.success {
        border-color: #28a745;
        background-color: rgba(40, 167, 69, 0.1);
      }

      .credential-set.error {
        border-color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
      }

      .credential-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .credential-name {
        font-weight: bold;
        font-size: 16px;
      }

      .test-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--vscode-descriptionForeground);
      }

      .test-status.testing {
        background-color: #ffa500;
        animation: pulse 1s infinite;
      }

      .test-status.success {
        background-color: #28a745;
      }

      .test-status.error {
        background-color: #dc3545;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--vscode-input-border);
        background-color: var(--vscode-input-background);
        color: var(--vscode-input-foreground);
        border-radius: 3px;
        box-sizing: border-box;
      }

      input:focus {
        outline: none;
        border-color: var(--vscode-focusBorder);
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      button {
        padding: 8px 16px;
        border: 1px solid var(--vscode-button-border);
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        border-radius: 3px;
        cursor: pointer;
        font-size: var(--vscode-font-size);
      }

      button:hover {
        background-color: var(--vscode-button-hoverBackground);
      }

      button:active {
        background-color: var(--vscode-button-background);
      }

      .test-btn {
        background-color: #007acc;
        border-color: #007acc;
      }

      .test-btn:hover {
        background-color: #005a9e;
      }

      .delete-btn {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
      }

      .delete-btn:hover {
        background-color: #c82333;
      }

      .context-menu {
        position: absolute;
        background-color: var(--vscode-menu-background);
        border: 1px solid var(--vscode-menu-border);
        border-radius: 3px;
        padding: 5px 0;
        z-index: 1000;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        color: var(--vscode-menu-foreground);
      }

      .context-menu-item:hover {
        background-color: var(--vscode-menu-selectionBackground);
        color: var(--vscode-menu-selectionForeground);
      }

      .url-display {
        background-color: var(--vscode-editor-inactiveSelectionBackground);
        padding: 8px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
        margin-bottom: 15px;
        word-break: break-all;
      }

      .status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 3px;
        display: none;
      }

      .status.success {
        background-color: var(--vscode-testing-iconPassed);
        color: var(--vscode-editor-background);
      }

      .status.error {
        background-color: var(--vscode-testing-iconFailed);
        color: var(--vscode-editor-background);
      }
    </style>
  </head>
  <body>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('uat')">
        UAT Environment
      </button>
      <button class="tab" onclick="switchTab('production')">
        Production Environment
      </button>
    </div>

    <div id="uat" class="tab-content active">
      <div class="environment-header">
        <h3>UAT Environment</h3>
        <button
          class="add-credential-btn"
          onclick="addNewCredentialSet('uat')"
          title="Add New Credential Set"
        >
          +
        </button>
      </div>

      <div class="url-display">
        <strong>API Endpoint:</strong> https://uat.api.converge.eu.elavonaws.com
      </div>

      <div id="uat-credentials-container">
        <!-- Credential sets will be dynamically added here -->
      </div>

      <div class="button-group">
        <button onclick="exportCredentials('uat')">Export All</button>
        <button onclick="importCredentials('uat')">Import</button>
      </div>
      <div id="uat-status" class="status"></div>
    </div>

    <div id="production" class="tab-content">
      <div class="environment-header">
        <h3>Production Environment</h3>
        <button
          class="add-credential-btn"
          onclick="addNewCredentialSet('production')"
          title="Add New Credential Set"
        >
          +
        </button>
      </div>

      <div class="url-display">
        <strong>API Endpoint:</strong> https://api.eu.convergepay.com
      </div>

      <div id="production-credentials-container">
        <!-- Credential sets will be dynamically added here -->
      </div>

      <div class="button-group">
        <button onclick="exportCredentials('production')">Export All</button>
        <button onclick="importCredentials('production')">Import</button>
      </div>
      <div id="production-status" class="status"></div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
      <div class="context-menu-item" onclick="testCredentialFromContext()">
        Test Connection
      </div>
      <div class="context-menu-item" onclick="deleteCredentialFromContext()">
        Delete Credential Set
      </div>
    </div>

    <script>
      // Get VS Code API
      const vscode = acquireVsCodeApi();

      // Store credential sets
      let credentialSets = {
        uat: [],
        production: [],
      };

      let contextMenuTarget = null;
      let credentialCounter = 0;

      // Initialize with default credential sets
      document.addEventListener("DOMContentLoaded", function () {
        addNewCredentialSet(
          "uat",
          "Credential Set 1",
          "demo123",
          "AKA_test",
          "secret_key_123"
        );
        addNewCredentialSet("production", "Credential Set 1", "", "", "");
      });

      function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active class from all tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName).classList.add("active");

        // Add active class to clicked tab
        event.target.classList.add("active");
      }

      function addNewCredentialSet(
        environment,
        name = null,
        merchantId = "",
        apiKey = "",
        apiSecret = ""
      ) {
        credentialCounter++;
        const credentialId = `${environment}-cred-${credentialCounter}`;
        const credentialName =
          name || `Credential Set ${credentialSets[environment].length + 1}`;

        const credentialSet = {
          id: credentialId,
          name: credentialName,
          merchantId: merchantId,
          apiKey: apiKey,
          apiSecret: apiSecret,
          status: "untested",
        };

        credentialSets[environment].push(credentialSet);
        renderCredentialSet(environment, credentialSet);
      }

      function renderCredentialSet(environment, credentialSet) {
        const container = document.getElementById(
          `${environment}-credentials-container`
        );

        const credentialDiv = document.createElement("div");
        credentialDiv.className = "credential-set";
        credentialDiv.id = credentialSet.id;
        credentialDiv.setAttribute("data-environment", environment);

        credentialDiv.innerHTML = `
                <div class="credential-header">
                    <input type="text" class="credential-name" value="${credentialSet.name}" 
                           onchange="updateCredentialName('${credentialSet.id}', this.value)" 
                           placeholder="Credential Set Name">
                    <div class="test-status" title="Connection Status"></div>
                </div>
                
                <div class="form-group">
                    <label>Merchant ID:</label>
                    <input type="text" value="${credentialSet.merchantId}" 
                           onchange="updateCredentialField('${credentialSet.id}', 'merchantId', this.value)"
                           placeholder="Enter Merchant ID">
                </div>
                
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="text" value="${credentialSet.apiKey}" 
                           onchange="updateCredentialField('${credentialSet.id}', 'apiKey', this.value)"
                           placeholder="Enter API Key">
                </div>
                
                <div class="form-group">
                    <label>API Secret:</label>
                    <input type="password" value="${credentialSet.apiSecret}" 
                           onchange="updateCredentialField('${credentialSet.id}', 'apiSecret', this.value)"
                           placeholder="Enter API Secret">
                </div>
                
                <div class="button-group">
                    <button class="test-btn" onclick="testCredentialSet('${credentialSet.id}')">Test Connection</button>
                    <button class="delete-btn" onclick="deleteCredentialSet('${credentialSet.id}')">Delete</button>
                </div>
            `;

        // Add right-click context menu
        credentialDiv.addEventListener("contextmenu", function (e) {
          e.preventDefault();
          showContextMenu(e, credentialSet.id);
        });

        container.appendChild(credentialDiv);
      }

      function updateCredentialName(credentialId, newName) {
        const environment = document
          .getElementById(credentialId)
          .getAttribute("data-environment");
        const credentialSet = credentialSets[environment].find(
          (c) => c.id === credentialId
        );
        if (credentialSet) {
          credentialSet.name = newName;
        }
      }

      function updateCredentialField(credentialId, field, value) {
        const environment = document
          .getElementById(credentialId)
          .getAttribute("data-environment");
        const credentialSet = credentialSets[environment].find(
          (c) => c.id === credentialId
        );
        if (credentialSet) {
          credentialSet[field] = value;
        }
      }

      function testCredentialSet(credentialId) {
        const environment = document
          .getElementById(credentialId)
          .getAttribute("data-environment");
        const credentialSet = credentialSets[environment].find(
          (c) => c.id === credentialId
        );

        if (!credentialSet) return;

        // Update UI to show testing state
        updateCredentialStatus(credentialId, "testing");

        // Get API endpoint URL
        const apiUrl =
          environment === "uat"
            ? "https://uat.api.converge.eu.elavonaws.com"
            : "https://api.eu.convergepay.com";

        vscode.postMessage({
          command: "testCredentialSet",
          credentialId: credentialId,
          environment: environment,
          credentials: {
            merchantId: credentialSet.merchantId,
            apiKey: credentialSet.apiKey,
            apiSecret: credentialSet.apiSecret,
            apiUrl: apiUrl,
          },
        });
      }

      function updateCredentialStatus(credentialId, status) {
        const credentialDiv = document.getElementById(credentialId);
        const statusIndicator = credentialDiv.querySelector(".test-status");

        // Remove existing status classes
        credentialDiv.classList.remove("testing", "success", "error");
        statusIndicator.classList.remove("testing", "success", "error");

        // Add new status class
        credentialDiv.classList.add(status);
        statusIndicator.classList.add(status);

        // Update tooltip
        const statusText = {
          testing: "Testing connection...",
          success: "Connection successful",
          error: "Connection failed",
          untested: "Not tested",
        };
        statusIndicator.title = statusText[status] || "Unknown status";
      }

      function deleteCredentialSet(credentialId) {
        const environment = document
          .getElementById(credentialId)
          .getAttribute("data-environment");

        // Remove from data
        credentialSets[environment] = credentialSets[environment].filter(
          (c) => c.id !== credentialId
        );

        // Remove from DOM
        document.getElementById(credentialId).remove();
      }

      function showContextMenu(event, credentialId) {
        const contextMenu = document.getElementById("context-menu");
        contextMenuTarget = credentialId;

        contextMenu.style.display = "block";
        contextMenu.style.left = event.pageX + "px";
        contextMenu.style.top = event.pageY + "px";
      }

      function testCredentialFromContext() {
        if (contextMenuTarget) {
          testCredentialSet(contextMenuTarget);
        }
        hideContextMenu();
      }

      function deleteCredentialFromContext() {
        if (contextMenuTarget) {
          deleteCredentialSet(contextMenuTarget);
        }
        hideContextMenu();
      }

      function hideContextMenu() {
        document.getElementById("context-menu").style.display = "none";
        contextMenuTarget = null;
      }

      // Hide context menu when clicking elsewhere
      document.addEventListener("click", hideContextMenu);

      function exportCredentials(environment) {
        vscode.postMessage({
          command: "exportCredentials",
          environment: environment,
          credentials: credentialSets[environment],
        });
      }

      function importCredentials(environment) {
        vscode.postMessage({
          command: "importCredentials",
          environment: environment,
        });
      }

      // Listen for messages from the extension
      window.addEventListener("message", (event) => {
        const message = event.data;

        switch (message.command) {
          case "showStatus":
            showStatus(message.environment, message.type, message.text);
            break;
          case "testResult":
            handleTestResult(
              message.credentialId,
              message.success,
              message.message
            );
            break;
          case "loadCredentials":
            loadCredentials(message.environment, message.credentials);
            break;
        }
      });

      function handleTestResult(credentialId, success, message) {
        const status = success ? "success" : "error";
        updateCredentialStatus(credentialId, status);

        // Show status message
        const environment = document
          .getElementById(credentialId)
          .getAttribute("data-environment");
        showStatus(environment, success ? "success" : "error", message);
      }

      function loadCredentials(environment, credentials) {
        // Clear existing credentials
        credentialSets[environment] = [];
        document.getElementById(
          `${environment}-credentials-container`
        ).innerHTML = "";

        // Load new credentials
        credentials.forEach((cred) => {
          credentialSets[environment].push(cred);
          renderCredentialSet(environment, cred);
        });
      }

      function showStatus(environment, type, text) {
        const statusElement = document.getElementById(`${environment}-status`);
        statusElement.textContent = text;
        statusElement.className = `status ${type}`;
        statusElement.style.display = "block";

        // Hide status after 5 seconds
        setTimeout(() => {
          statusElement.style.display = "none";
        }, 5000);
      }
    </script>
  </body>
</html>
